{% extends 'base_vicafpro.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}
{% if servicio %}Editar Servicio{% else %}Crear Servicio{% endif %}
{% endblock %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 rounded-lg">
    <main class="mx-auto max-w-7xl p-6 lg:p-8">
        <div class="animate-fade-in-up">
            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-xl font-extrabold text-white mb-2">
                    {% if servicio %}Editar Servicio{% else %}Crear Nuevo Servicio{% endif %}
                </h1>
                <p class="text-slate-400 mt-1 text-sm">
                    Completa los campos para {% if servicio %}actualizar{% else %}crear{% endif %} 
                    un servicio y sus detalles.
                </p>
            </header>

            <!-- Formulario Principal -->
            <form method="post" enctype="multipart/form-data" class="space-y-8">
                {% csrf_token %}

                <!-- Sección Información del Servicio -->
                <section class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-6">Información del Servicio</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="form-field md:col-span-2 lg:col-span-2">
                            <div>
                                <label for="id_nombre" class="form-label text-sm">Nombre del Servicio</label>
                            </div>
                            <div>
                                 {{ form.nombre|add_class:"form-input w-full" }}
                                {% if form.nombre.help_text %}<p class="form-help-text ">{{ form.nombre.help_text }}</p>{% endif %}
                                {% if form.nombre.errors %}<div class="form-error">{{ form.nombre.errors }}</div>{% endif %}
                            </div>
                            
                           
                        </div>
                        
                        <div class="form-field md:col-span-1 lg:col-span-2">
                            <div>
                                <label for="id_orden" class="form-label text-sm">Orden</label>
                            </div>
                            <div>
                                {{ form.orden|add_class:"form-input w-full" }}
                                {% if form.orden.help_text %}<p class="form-help-text 0 p-2">{{ form.orden.help_text }}</p>{% endif %}
                                {% if form.orden.errors %}<div class="form-error bg-slate-80 rounded-lg">{{ form.orden.errors }}</div>{% endif %}
                            </div>
                        </div>
                        
                        <div class="form-field md:col-span-2 lg:col-span-2  ">
                            <label for="id_descripcion" class="form-label">Descripción del Servicio</label>
                            {{ form.descripcion|add_class:"form-textarea" }}
                            {% if form.descripcion.help_text %}<p class="form-help-text">{{ form.descripcion.help_text }}</p>{% endif %}
                            {% if form.descripcion.errors %}<div class="form-error">{{ form.descripcion.errors }}</div>{% endif %}
                        </div>
                        
                        <div class="form-field md:col-span-2 lg:col-span-2">
                            <label for="id_imagen" class="form-label">Imagen</label>
                            {% if form.imagen.value %}
                                <img src="{{ form.imagen.value.url }}" 
                                     alt="Imagen actual" 
                                     class="mt-2 h-40 w-full object-cover rounded-lg shadow-md"
                                     loading="lazy">
                            {% endif %}
                            {{ form.imagen|add_class:"form-input-file" }}
                            {% if form.imagen.help_text %}<p class="form-help-text">{{ form.imagen.help_text }}</p>{% endif %}
                            {% if form.imagen.errors %}<div class="form-error">{{ form.imagen.errors }}</div>{% endif %}
                        </div>
                    </div>
                </section>

                <!-- Sección Detalles del Servicio -->
                <section class="bg-black/30 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-white">Detalles del Servicio</h2>
                        <button type="button" id="add-detail-btn" 
                                class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-500 
                                       text-white font-semibold rounded-full 
                                       hover:bg-emerald-600 transition-all duration-300 
                                       transform hover:scale-105 shadow-md">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Añadir Detalle
                        </button>
                    </div>

                    <div id="formset-container" class="space-y-6">
                        {{ formset.management_form }}
                        {% for form in formset %}
                            <div class="form-field-group card p-6 rounded-lg bg-slate-800/50 
                                      border border-slate-700/50 shadow-inner">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-white">
                                        Detalle #{{ forloop.counter }}
                                    </h3>
                                    {% if form.instance.pk %}
                                        <label class="text-sm text-rose-400 flex items-center gap-2 
                                                   cursor-pointer hover:text-rose-300 transition-colors">
                                            {{ form.DELETE }} Eliminar
                                        </label>
                                    {% endif %}
                                </div>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 w-full">
                                    {% for field in form %}
                                        {% if field.name != 'DELETE' and field.name != 'servicio' %}
                                            <div class="form-field {% if field.name == 'descripcion' or field.name == 'imagen' %}md:col-span-2{% endif %}">
                                                <div>
                                                    <label for="{{ field.id_for_label }}" class="form-label">
                                                        {{ field.label }}
                                                    </label>
                                                </div>
                                                <div>
                                                    {% if field.name == 'imagen' %}
                                                    {{ field|add_class:"form-input-file" }}
                                                    {% elif field.name == 'descripcion' %}
                                                        {{ field|add_class:"form-textarea" }}
                                                    {% else %}
                                                        {{ field|add_class:"form-input" }}
                                                    {% endif %}
                                                    {% if field.help_text %}<p class="form-help-text">{{ field.help_text }}</p>{% endif %}
                                                    {% if field.errors %}<div class="form-error">{{ field.errors }}</div>{% endif %}
                                                    
                                                </div>
                                                
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Botones de Acción -->
                <div class="flex justify-end gap-4 pt-8">
                    <button type="submit" class="btn-primary inline-flex items-center gap-2 px-6 py-3 bg-emerald-500 
                                       text-white font-semibold rounded-full 
                                       hover:bg-emerald-600 transition-all duration-300 
                                       transform hover:scale-105 shadow-md">
                        {% if servicio %}<i data-lucide="save" class="w-5 h-5 mr-2"></i> 
                        Guardar Cambios{% else %}<i data-lucide="plus" class="w-5 h-5 mr-2"></i> 
                        Crear Servicio{% endif %}
                    </button>
                    <a href="{% url 'servicios:servicio_list' %}" class="btn-secondary inline-flex items-center gap-2 px-6 py-3 bg-emerald-500 
                                       text-white font-semibold rounded-full 
                                       hover:bg-emerald-600 transition-all duration-300 
                                       transform hover:scale-105 shadow-md">
                        <i data-lucide="x" class="w-5 h-5 mr-2"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- Template para nuevos formularios dinámicos -->
<template id="empty-form">
    <div class="form-field-group card p-6 rounded-lg bg-slate-800/50 border border-slate-700/50 shadow-inner">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-white">Detalle #<span></span></h3>
            <label class="text-sm text-rose-400 flex items-center gap-2 cursor-pointer hover:text-rose-300 transition-colors">
                <input type="checkbox" name="__prefix__-DELETE" id="id___prefix__-DELETE"> Eliminar
            </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-field">
                <label for="id___prefix__-titulo" class="form-label">Título del Detalle</label>
                <input type="text" name="__prefix__-titulo" id="id___prefix__-titulo" class="form-input">
            </div>
            <div class="form-field md:col-span-2">
                <label for="id___prefix__-descripcion" class="form-label">Descripción del Detalle</label>
                <textarea name="__prefix__-descripcion" id="id___prefix__-descripcion" class="form-textarea"></textarea>
            </div>
            <div class="form-field md:col-span-2">
                <label for="id___prefix__-imagen" class="form-label">Imagen</label>
                <input type="file" name="__prefix__-imagen" id="id___prefix__-imagen" class="form-input-file">
            </div>
        </div>
    </div>
</template>

<style>
.form-input, .form-textarea, .form-select {
@apply w-full p-3 rounded-lg bg-slate-700/50 text-white border border-transparent 
       focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 
       transition-colors duration-200 placeholder-slate-400;
}
.form-textarea {
@apply resize-y min-h-[150px];
}
.form-input-file {
@apply w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-full 
       file:border-0 file:text-sm file:font-semibold file:bg-violet-50 
       file:text-violet-700 hover:file:bg-violet-100 transition-colors 
       duration-300;
}
.form-label {
@apply block text-sm font-medium text-white mb-1;
}
.form-help-text {
@apply mt-1 text-sm text-slate-400;
}
.form-error {
@apply mt-1 text-sm text-rose-500;
}
.btn-primary {
@apply inline-flex items-center px-6 py-3 border border-transparent 
       text-base font-semibold rounded-full shadow-md text-white 
       bg-emerald-600 hover:bg-emerald-700 transition-all duration-300 
       transform hover:scale-105;
}
.btn-secondary {
@apply inline-flex items-center px-6 py-3 border border-slate-600 
       text-base font-semibold rounded-full shadow-md text-slate-300 
       bg-transparent hover:bg-slate-700 transition-all duration-300 
       transform hover:scale-105;
}

/* Efectos visuales adicionales */
.backdrop-blur-sm {
    backdrop-filter: blur(5px);
}
.shadow-inner {
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-detail-btn');
        const managementForm = document.getElementById('id_detalles_cotizacion-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form');

        let formCount = parseInt(managementForm.value);

        addButton.addEventListener('click', function() {
            const templateHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formCount);
            
            const newForm = document.createElement('div');
            newForm.innerHTML = templateHtml;

            const formNumberSpan = newForm.querySelector('h3 span');
            if (formNumberSpan) {
                formNumberSpan.textContent = formCount + 1;
            }

            container.appendChild(newForm);
            
            formCount++;
            managementForm.value = formCount;
        });

        const forms = container.querySelectorAll('.form-field-group');
        forms.forEach((formElement, index) => {
            const formNumberSpan = formElement.querySelector('h3 span');
            if (formNumberSpan) {
                formNumberSpan.textContent = index + 1;
            }
        });
    });
</script>
{% endblock %}