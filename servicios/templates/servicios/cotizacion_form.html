{% extends "base_vicafpro.html" %}

{% load static %}

{% block title %}Generador de Cotización{% endblock %}

{% block content %}
<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        border: 2px solid transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }

    /* Estilo para los inputs con el nuevo tema */
    .glass-input {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        transition: all 0.3s ease;
    }

    .glass-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 10px var(--accent-cyan);
    }

    .glass-input::placeholder {
        color: var(--text-muted);
    }

    /* Color para los iconos dentro de los inputs */
    .input-icon {
        color: var(--text-muted);
        transition: color 0.3s ease;
    }

    .input-container:has(.glass-input:focus) .input-icon {
        color: var(--accent-cyan);
    }

    .select-icon {
        color: var(--text-muted);
    }
</style>
<style>
    .glass-input-table {
        background-color: transparent;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-light);
        transition: all 0.2s ease;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem; /* text-sm */
        line-height: 1.25rem;
    }

    .glass-input-table:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 1px 0 0 var(--accent-cyan);
    }
</style>
<main class="flex-grow p-4 sm:p-2 flex flex-col items-start justify-center gap-6">
    <div class="w-full flex flex-col lg:flex-row items-start justify-center gap-6">
        <div class="glass-panel p-2 sm:p-2 w-full lg:w-full max-w-full flex flex-col">
            <div class="flex justify-between items-center mb-4 rounded-lg shadow-lg mb-4 border-b-2">
                <img src="{% static 'img/LogoF.png' %}" alt="Logo de la empresa"
                    class="rounded-lg h-16 w-32 mb-2">
                <div class="text-right text-sm">
                    <span id="userIdDisplay" class="block font-medium text-text-muted"></span>
                    <span id="firebase-status" class="block font-medium text-golden"></span>
                </div>
            </div>
            <div class="flex mt-2">
                <svg class="w-8 h-8 mb-2 fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                    <path
                        d="M320 48C306.7 48 296 58.7 296 72L296 84L294.2 84C257.6 84 228 113.7 228 150.2C228 183.6 252.9 211.8 286 215.9L347 223.5C352.1 224.1 356 228.5 356 233.7C356 239.4 351.4 243.9 345.8 243.9L272 244C256.5 244 244 256.5 244 272C244 287.5 256.5 300 272 300L296 300L296 312C296 325.3 306.7 336 320 336C333.3 336 344 325.3 344 312L344 300L345.8 300C382.4 300 412 270.3 412 233.8C412 200.4 387.1 172.2 354 168.1L293 160.5C287.9 159.9 284 155.5 284 150.3C284 144.6 288.6 140.1 294.2 140.1L360 140C375.5 140 388 127.5 388 112C388 96.5 375.5 84 360 84L344 84L344 72C344 58.7 333.3 48 320 48zM141.3 405.5L98.7 448L64 448C46.3 448 32 462.3 32 480L32 544C32 561.7 46.3 576 64 576L384.5 576C413.5 576 441.8 566.7 465.2 549.5L591.8 456.2C609.6 443.1 613.4 418.1 600.3 400.3C587.2 382.5 562.2 378.7 544.4 391.8L424.6 480L312 480C298.7 480 288 469.3 288 456C288 442.7 298.7 432 312 432L384 432C401.7 432 416 417.7 416 400C416 382.3 401.7 368 384 368L231.8 368C197.9 368 165.3 381.5 141.3 405.5z" />
                </svg>
                <h1 class="ml-4 text-lg sm:text-2xl font-extrabold text-left text-white mb-2 leading-tight mt-1">
                    Generador de Cotización
                </h1>
            </div>
            <p class="text-self mt-4 text-text-muted mb-8 sm:mb-10 text-sm">
                Completa los datos para crear una oferta técnica-económica.
            </p>

            <div class="grid md:grid-cols-2 gap-6 md:gap-8 flex-grow">
                <div class="md:col-span-2">
                    <h2 class="flex items-center text-xl font-semibold text-accent-cyan mb-4">
                        <i data-lucide="building" class="w-5 h-5 mr-2 text-golden"></i>
                        Datos del Cliente
                    </h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="relative input-container">
                            <input type="text" id="clientName"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="Razón social">
                            <i data-lucide="user"
                                class="input-icon absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5"></i>
                        </div>
                        <div class="relative input-container">
                            <input type="text" id="clientRUC"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="DNI/RUC">
                            <i data-lucide="id-card"
                                class="input-icon absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5"></i>
                        </div>
                        <div class="relative input-container">
                            <input type="text" id="contactName"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="Persona de contacto">
                            <i data-lucide="user"
                                class="input-icon absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5"></i>
                        </div>
                        <div class="relative input-container">
                            <input type="email" id="contactEmail"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="Correo electrónico">
                            <i data-lucide="mail"
                                class="input-icon absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5"></i>
                        </div>
                        <div class="relative input-container">
                            <input type="tel" id="contactPhone"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="Teléfono">
                            <i data-lucide="phone"
                                class="input-icon absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5"></i>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <h2 class="flex items-center text-xl font-semibold text-accent-cyan mb-4 mt-6">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 text-golden"></i>
                        Detalles de la cotización
                    </h2>

                    <div class="sm:col-span-2">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-text-light">Ítems de la Cotización</h3>
                            <button id="addItemBtn" type="button"
                                class="flex items-center space-x-1 font-light text-sm py-1 px-3 rounded-lg action-button">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                <span>Agregar Ítem</span>
                            </button>
                        </div>

                        <div class="mb-6 overflow-x-auto">
                            <table class="w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[30px]">
                                            #
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[200px]">
                                            Descripción
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider hidden md:table-cell min-w-[100px]">
                                            Norma
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider hidden lg:table-cell min-w-[100px]">
                                            Método
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[60px]">
                                            Und.
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[60px]">
                                            Cant.
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[80px]">
                                            P. Unit (S/.)
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[100px]">
                                            P. Parcial (S/.)
                                        </th>
                                        <th
                                            class="px-1 sm:px-3 py-2 text-left text-xs font-medium text-text-muted uppercase tracking-wider min-w-[60px]">
                                            Acción
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody" class="bg-transparent divide-y divide-gray-800">
                                    </tbody>
                                <tfoot>
                                    <tr class="bg-blue-950">
                                        <td colspan="7" class="px-3 py-2 text-right text-sm font-semibold text-text-light">
                                            SUBTOTAL
                                        </td>
                                        <td class="px-3 py-2 text-left text-sm font-bold text-text-light">
                                            <span id="subtotalAmount">S/ 0.00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr class="bg-blue-950">
                                        <td colspan="7" class="px-3 py-2 text-right text-sm font-semibold text-text-light">
                                            I.G.V. (18%)
                                        </td>
                                        <td class="px-3 py-2 text-left text-sm font-bold text-text-light">
                                            <span id="igvAmount">S/ 0.00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                    <tr class="bg-blue-950">
                                        <td colspan="7" class="px-3 py-2 text-right text-sm font-semibold text-text-light">
                                            TOTAL
                                        </td>
                                        <td class="px-3 py-2 text-left text-sm font-bold text-accent-golden">
                                            <span id="totalFinalAmount">S/ 0.00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="relative input-container">
                            <label for="deliveryDays" class="text-sm font-medium text-text-muted mb-1 block">Plazo de entrega
                                (días)</label>
                            <input type="number" id="deliveryDays" name="plazo_entrega_dias"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input"
                                placeholder="Ej: 7" value="0">
                            <i data-lucide="calendar-check"
                                class="input-icon absolute left-3 top-[37px] -translate-y-1/2 h-5 w-5"></i>
                        </div>
                        <div class="relative input-container">
                            <label for="paymentMethod" class="text-sm font-medium text-text-muted mb-1 block">Forma de
                                pago</label>
                            <select id="paymentMethod"
                                class="w-full p-3 rounded-lg transition-all duration-200 glass-input appearance-none">
                                <option value="Por adelantado">Por adelantado</option>
                                <option value="XX% por adelantado y XX% previo a la entrega">XX% por adelantado y XX%
                                    previo a la entrega</option>
                                <option value="Posterior a la conformidad del servicio">Posterior a la conformidad del
                                    servicio</option>
                            </select>
                            <div
                                class="absolute inset-y-0 right-0 top-6 flex items-center px-2 pointer-events-none select-icon">
                                <i data-lucide="chevron-down" class="h-5 w-5"></i>
                            </div>
                        </div>
                        <div class="relative input-container">
                            <label for="offerValidity" class="text-sm font-medium text-text-muted mb-1 block">Validez de la
                                oferta (días)</label>
                            <input type="number" id="offerValidity"
                                class="w-full p-3 pl-10 rounded-lg transition-all duration-200 glass-input" value="30">
                            <i data-lucide="clock"
                                class="input-icon absolute left-3 top-[37px] -translate-y-1/2 h-5 w-5"></i>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 mt-4 flex justify-center">
                    <button id="generateAndSaveBtn"
                        class="flex items-center space-x-2 font-light text-sm py-2 px-6 rounded-xl action-button">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span>Generar y guardar cotización</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="resultSection" class="glass-panel p-6 sm:p-10 w-full mt-6 hidden flex-grow flex flex-col">
        <h2 class="flex items-center text-xl font-semibold text-accent-cyan mb-4">
            <i data-lucide="clipboard" class="w-5 h-5 mr-2 text-golden"></i>
            Cotización generada
        </h2>
        <div class="bg-[var(--secondary-bg)] p-6 rounded-xl border border-[var(--border-color)] relative flex-grow">
            <textarea id="generatedQuote" rows="15" readonly
                class="w-full h-full bg-transparent text-text-light text-sm focus:outline-none resize-none custom-scrollbar"></textarea>
            <button id="copyBtn"
                class="absolute top-3 right-3 bg-[var(--secondary-bg)] text-text-muted p-2 rounded-full shadow-lg hover:bg-[var(--corporate-blue-light)] transition-colors duration-200">
                <i data-lucide="copy" class="w-5 h-5"></i>
            </button>
            <div id="copyStatus"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-accent-golden text-[var(--corporate-blue-dark)] px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none">
                ¡Copiado!
            </div>
        </div>
    </div>


    <div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-panel p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 text-center">
            <h3 id="modalHeader" class="text-xl font-bold mb-4 text-accent-cyan"></h3>
            <p id="modalMessage" class="text-text-light"></p>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Función para obtener el token CSRF ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const generateAndSaveBtn = document.getElementById('generateAndSaveBtn');
        const resultSection = document.getElementById('resultSection');
        const generatedQuote = document.getElementById('generatedQuote');
        const copyBtn = document.getElementById('copyBtn');
        const copyStatus = document.getElementById('copyStatus');
        const clientRUCInput = document.getElementById('clientRUC');
        const clientNameInput = document.getElementById('clientName');
        const contactNameInput = document.getElementById('contactName');
        const contactEmailInput = document.getElementById('contactEmail');
        const contactPhoneInput = document.getElementById('contactPhone');

        // Función para mostrar un modal
        const showMessageModal = (message, type = 'info') => {
            const modal = document.getElementById('messageModal');
            const messageText = document.getElementById('modalMessage');
            const modalHeader = document.getElementById('modalHeader');
            if (!modal || !messageText || !modalHeader) return;
            messageText.textContent = message;
            modalHeader.textContent = type === 'success' ? 'Éxito' : (type === 'error' ? 'Error' : 'Información');
            modalHeader.className = type === 'success' ? 'text-accent-golden text-xl font-bold' : (type === 'error' ? 'text-red-400 text-xl font-bold' : 'text-accent-cyan text-xl font-bold');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 3000);
        };

        // Función para generar un número de oferta simple
        const generateOfferNumber = () => {
            const year = new Date().getFullYear().toString().slice(-2);
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `VCF-OTE-${year}-${randomNum}`;
        };

        // --- FUNCIONES PARA LA LÓGICA DE BÚSQUEDA Y CREACIÓN DE ÍTEMS ---
        const itemsTableBody = document.getElementById('itemsTableBody');
        const addItemBtn = document.getElementById('addItemBtn');
        let itemCounter = 0;

        // Función para obtener los datos de la tabla de ítems y los totales
        const getQuoteItemsData = () => {
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const servicioId = row.querySelector('[name="servicio_id"]').value;
                const detalleId = row.querySelector('[name="detalle_id"]').value;
                
                // Solo agrega el ítem si tiene un servicio válido
                if (servicioId && detalleId) {
                    items.push({
                        servicio: servicioId,
                        detalle_servicio: detalleId,
                        und: row.querySelector('[name="und"]').value,
                        cantidad: parseFloat(row.querySelector('[name="cantidad"]').value) || 0,
                        precio_unitario: parseFloat(row.querySelector('[name="precio_unitario"]').value) || 0,
                    });
                }
            });
            const subtotal = parseFloat(document.getElementById('subtotalAmount').textContent.replace('S/ ', '')) || 0;
            const igv = parseFloat(document.getElementById('igvAmount').textContent.replace('S/ ', '')) || 0;
            const total = parseFloat(document.getElementById('totalFinalAmount').textContent.replace('S/ ', '')) || 0;

            return { items, subtotal, igv, total };
        };

        const updatePreview = () => {
            const { items, subtotal, igv, total } = getQuoteItemsData();

            let itemsText = '';
            items.forEach((item, index) => {
                const descripcion = itemsTableBody.children[index].querySelector('[name="descripcion"]').value;
                const und = itemsTableBody.children[index].querySelector('[name="und"]').value;
                const cantidad = itemsTableBody.children[index].querySelector('[name="cantidad"]').value;
                const precio_unitario = itemsTableBody.children[index].querySelector('[name="precio_unitario"]').value;
                
                if (descripcion) {
                    itemsText += ` - ${descripcion} (${und})\n`;
                    itemsText += `   Cantidad: ${cantidad}, P. Unitario: S/ ${parseFloat(precio_unitario).toFixed(2)}\n`;
                }
            });

            const clientName = document.getElementById('clientName').value;
            const clientRUC = document.getElementById('clientRUC').value;
            const contactName = document.getElementById('contactName').value;
            const deliveryDays = document.getElementById('deliveryDays').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const offerValidity = document.getElementById('offerValidity').value;

            const previewText = `
COTIZACIÓN: ${generateOfferNumber()}
FECHA: ${new Date().toLocaleDateString('es-ES')}

CLIENTE:
Razón Social: ${clientName || '...'}
RUC: ${clientRUC || '...'}
Persona de Contacto: ${contactName || '...'}

DETALLE DEL SERVICIO:
${itemsText || '...'}

VALOR DE LA OFERTA:
Subtotal: S/ ${subtotal.toFixed(2)}
I.G.V. (18%): S/ ${igv.toFixed(2)}
Monto Total: S/ ${total.toFixed(2)}

CONDICIONES COMERCIALES:
Plazo de Entrega: ${deliveryDays || '0'} días hábiles.
Forma de Pago: ${paymentMethod || '...'}
Validez de la Oferta: ${offerValidity || '30'} días calendario.

`;
            generatedQuote.value = previewText.trim();
        };

        const addItemRow = () => {
            itemCounter++;
            const newRow = document.createElement('tr');
            newRow.className = 'item-row transition-colors duration-200 hover:bg-gray-900';
            newRow.innerHTML = `
                <td class="px-3 py-2 text-sm text-text-muted"><span class="item-number">${itemCounter}</span></td>
                <td class="px-3 py-2 relative">
                    <input type="text" name="descripcion" class="glass-input-table w-full service-search" placeholder="Buscar servicio...">
                    <input type="hidden" name="servicio_id">
                    <input type="hidden" name="detalle_id">
                    <div class="absolute z-10 bg-gray-800 border border-gray-700 mt-1 w-full rounded-md shadow-lg hidden service-results"></div>
                </td>
                <td class="px-3 py-2"><input type="text" name="norma" class="glass-input-table w-full" readonly></td>
                <td class="px-3 py-2"><input type="text" name="metodo" class="glass-input-table w-full" readonly></td>
                <td class="px-3 py-2"><input type="text" name="und" class="glass-input-table w-16"></td>
                <td class="px-3 py-2"><input type="number" name="cantidad" class="glass-input-table w-16" min="0"></td>
                <td class="px-3 py-2"><input type="number" name="precio_unitario" class="glass-input-table w-24" min="0" step="0.01"></td>
                <td class="px-3 py-2"><span class="p-parcial">S/ 0.00</span></td>
                <td class="px-3 py-2 text-sm text-center">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </td>
            `;
            itemsTableBody.appendChild(newRow);

            const searchInput = newRow.querySelector('.service-search');
            const resultsDiv = newRow.querySelector('.service-results');
            const descripcionInput = newRow.querySelector('[name="descripcion"]');
            const servicioIdInput = newRow.querySelector('[name="servicio_id"]');
            const detalleIdInput = newRow.querySelector('[name="detalle_id"]');
            const normaInput = newRow.querySelector('[name="norma"]');
            const metodoInput = newRow.querySelector('[name="metodo"]');
            const undInput = newRow.querySelector('[name="und"]');
            const cantidadInput = newRow.querySelector('[name="cantidad"]');
            const unitPriceInput = newRow.querySelector('[name="precio_unitario"]');
            const partialPriceSpan = newRow.querySelector('.p-parcial');
            const removeBtn = newRow.querySelector('.remove-item-btn');

            let searchTimeout;

            // Lógica de búsqueda de servicios
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value;
                if (query.length < 3) {
                    resultsDiv.classList.add('hidden');
                    return;
                }
                searchTimeout = setTimeout(async () => {
                    const response = await fetch(`/servicios/api/buscar-servicio/?q=${query}`);
                    const data = await response.json();
                    resultsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(item => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-2 cursor-pointer hover:bg-gray-700 text-sm text-text-light';
                            resultItem.textContent = `${item.servicio_nombre} - ${item.detalle_titulo}`;
                            resultItem.dataset.servicioId = item.servicio_id;
                            resultItem.dataset.detalleId = item.id;
                            resultItem.dataset.norma = item.normas.join(', ');
                            resultItem.dataset.metodo = item.metodos.join(', ');
                            resultItem.dataset.und = 'UND'; // Valor por defecto
                            resultItem.addEventListener('click', () => {
                                // Rellenar los campos de la fila
                                descripcionInput.value = item.detalle_titulo;
                                servicioIdInput.value = item.servicio_id;
                                detalleIdInput.value = item.id;
                                normaInput.value = item.normas.join(', ');
                                metodoInput.value = item.metodos.join(', ');
                                undInput.value = 'UND';
                                resultsDiv.classList.add('hidden');
                                updatePreview();
                            });
                            resultsDiv.appendChild(resultItem);
                        });
                        resultsDiv.classList.remove('hidden');
                    } else {
                        resultsDiv.classList.add('hidden');
                    }
                }, 300);
            });
            
            // Ocultar resultados si se hace clic fuera
            document.addEventListener('click', (event) => {
                if (!newRow.contains(event.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });


            const updatePartialAndTotals = () => {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precio_unitario = parseFloat(unitPriceInput.value) || 0;
                const p_parcial = cantidad * precio_unitario;
                partialPriceSpan.textContent = `S/ ${p_parcial.toFixed(2)}`;
                updateTotals();
                updatePreview();
            };

            cantidadInput.addEventListener('input', updatePartialAndTotals);
            unitPriceInput.addEventListener('input', updatePartialAndTotals);

            removeBtn.addEventListener('click', () => {
                newRow.remove();
                reindexItems();
                updateTotals();
                updatePreview();
            });

            updatePartialAndTotals();
            lucide.createIcons();
        };

        const updateTotals = () => {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const partialPriceText = row.querySelector('.p-parcial').textContent;
                const partialPrice = parseFloat(partialPriceText.replace('S/ ', '')) || 0;
                subtotal += partialPrice;
            });

            const igv = subtotal * 0.18;
            const total = subtotal + igv;

            document.getElementById('subtotalAmount').textContent = `S/ ${subtotal.toFixed(2)}`;
            document.getElementById('igvAmount').textContent = `S/ ${igv.toFixed(2)}`;
            document.getElementById('totalFinalAmount').textContent = `S/ ${total.toFixed(2)}`;
        };

        const reindexItems = () => {
            itemCounter = 0;
            document.querySelectorAll('.item-row').forEach((row, index) => {
                row.querySelector('.item-number').textContent = index + 1;
                itemCounter = index + 1;
            });
        };

        let clientSearchTimeout;
        clientRUCInput.addEventListener('input', () => {
            clearTimeout(clientSearchTimeout);
            const query = clientRUCInput.value;
            if (query.length >= 8) { // 8 para DNI, 11 para RUC. Lo dejamos flexible
                clientSearchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/servicios/api/buscar-cliente/?q=${query}`);
                        const data = await response.json();
                        if (data && data.razon_social) {
                            clientNameInput.value = data.razon_social;
                            contactNameInput.value = data.persona_contacto || '';
                            contactEmailInput.value = data.correo_contacto || '';
                            contactPhoneInput.value = data.telefono_contacto || '';
                            showMessageModal('Cliente encontrado y campos rellenados.', 'success');
                        } else {
                            showMessageModal('Cliente no encontrado.', 'info');
                            clientNameInput.value = '';
                            contactNameInput.value = '';
                            contactEmailInput.value = '';
                            contactPhoneInput.value = '';
                        }
                    } catch (error) {
                        console.error('Error al buscar cliente:', error);
                        showMessageModal('Error en la búsqueda del cliente.', 'error');
                    }
                }, 500);
            }
        });

        generateAndSaveBtn.addEventListener('click', async () => {
            const numeroOferta = generateOfferNumber();
            const { total, items } = getQuoteItemsData();

            const formData = {
                numero_oferta: numeroOferta,
                razon_social: document.getElementById('clientName').value,
                ruc: document.getElementById('clientRUC').value,
                persona_contacto: document.getElementById('contactName').value,
                correo_contacto: document.getElementById('contactEmail').value,
                telefono_contacto: document.getElementById('contactPhone').value,
                forma_pago: document.getElementById('paymentMethod').value,
                validez_oferta_dias: parseInt(document.getElementById('offerValidity').value) || 30,
                plazo_entrega_dias: parseInt(document.getElementById('deliveryDays').value) || 0,
                monto_total: total, // Nuevo campo para el monto total
                detalles: items // Nuevo campo para los detalles de la cotización
            };

            if (!formData.razon_social || !formData.ruc || !formData.persona_contacto || !formData.correo_contacto) {
                showMessageModal('Por favor, completa todos los campos del cliente.', 'error');
                return;
            }

            if (formData.detalles.length === 0 || total <= 0) {
                showMessageModal('Por favor, agrega al menos un ítem con valores válidos.', 'error');
                return;
            }
            try {
                const response = await fetch('/servicios/api/cotizaciones/crear/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error al guardar:', errorData);
                    throw new Error(JSON.stringify(errorData));
                }
                const newQuote = await response.json();
                showMessageModal(`Cotización ${newQuote.numero_oferta} guardada con éxito!`, 'success');
                resultSection.classList.remove('hidden');
                updatePreview();
            } catch (error) {
                console.error("Error:", error);
                showMessageModal(`Error al guardar. Detalles: ${error.message}`, 'error');
            }
        });

        addItemBtn.addEventListener('click', addItemRow);
        copyBtn.addEventListener('click', () => {
            if (!generatedQuote.value) {
                showMessageModal('No hay cotización para copiar.', 'error');
                return;
            }
            generatedQuote.select();
            try {
                document.execCommand('copy');
                copyStatus.classList.remove('opacity-0');
                copyStatus.classList.add('opacity-100');
                setTimeout(() => {
                    copyStatus.classList.remove('opacity-100');
                    copyStatus.classList.add('opacity-0');
                }, 2000);
            } catch (err) {
                console.error('Error al copiar el texto', err);
            }
        });
    });
</script>
{% endblock %}