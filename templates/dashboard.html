{% extends 'base_vicafpro.html' %}
{% load static %}

{% block title %}VICAFPRO - Panel de Control{% endblock %}

{% block content %}

<div id="inicio-content">
    <header id="main-header" class="flex justify-between items-center mb-10 animate-fade-in-up">
        <div>
            <h1 class="text-4xl font-extrabold text-white">Panel de Control</h1>
            <p class="text-slate-400 mt-1">Hola, {{ user.get_full_name|default:user.username }}. Bienvenido al futuro de la gesti√≥n.</p>
        </div>
        <button id="command-palette-button-main"
            class="px-4 py-2 glass-card rounded-lg text-slate-300 hover:text-white hover:border-slate-400/50 transition-colors flex items-center gap-2">
            B√∫squeda r√°pida <span class="text-xs border border-slate-500 rounded px-1.5 py-0.5">Ctrl K</span>
        </button>
    </header>
    <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
    </div>
</div>

<div id="analisis-content" class="hidden">
</div>

<div id="card-overlay"
    class="fixed inset-0 z-40 flex justify-center items-center bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300">
    <div id="submenu-modal" class="glass-card rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm m-4 p-4 transform scale-95 opacity-0 transition-all duration-300">
        <header class="flex justify-between items-center mb-4 pb-2 border-b border-white/10">
            <h3 id="submenu-title" class="text-xl font-bold text-white"></h3>
            <button id="close-submenu" class="text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>
        <ul id="submenu-list" class="space-y-2">
            </ul>
    </div>
</div>

{% endblock %}

{% block extra_content %}
<div id="command-palette"
    class="fixed inset-0 z-50 flex justify-center items-start pt-20 bg-black/50 backdrop-blur-sm hidden">
    <div class="glass-card w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden border-emerald-500/50">
        <input id="command-input" type="text" placeholder="Escribe un comando o busca una p√°gina..."
            class="w-full p-4 text-lg bg-transparent text-white focus:outline-none border-b border-slate-500/50">
        <ul id="command-list" class="p-2 max-h-96 overflow-y-auto"></ul>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const navigationData = [
            {
                id: 'clientes',
                icon: 'üë•',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Clientes',
                desc: 'Administra y revisa la base de datos de clientes.',
                glow: '#14b8a6',
                children: [
                    { id: 'lista_clientes', url: "{% url 'clientes:lista_clientes' %}", icon: 'üìã', title: 'Listado de Clientes', desc: 'Ver todos los clientes registrados.', category: 'Clientes' },
                    { id: 'crear_cliente', url: "{% url 'clientes:crear_cliente' %}", icon: '‚ûï', title: 'Crear Cliente', desc: 'Registrar un nuevo perfil de cliente.', category: 'Clientes' },
                ]
            },
            {
                id: 'servicios',
                icon: 'üîß',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Servicios',
                desc: 'Administra los servicios y las cotizaciones de la empresa.',
                glow: '#f59e0b',
                children: [
                    { id: 'servicios', url: "{% url 'servicios:lista_servicios' %}", icon: 'üìÉ', title: 'Listado de Servicios', desc: 'Ver el cat√°logo de servicios.', category: 'Servicios' },
                    { id: 'crear_servicio', url: "{% url 'servicios:crear_servicio' %}", icon: '‚ûï', title: 'Crear Servicio', desc: 'Registrar un nuevo servicio.', category: 'Servicios' },
                    { 
                        id: 'cotizaciones', 
                        icon: 'üí∏', 
                        title: 'Gesti√≥n de Cotizaciones', 
                        desc: 'Administra las cotizaciones de servicios.',
                        category: 'Cotizaciones',
                        children: [
                            { id: 'listar_cotizaciones', url: "{% url 'servicios:lista_cotizaciones' %}", icon: 'üìã', title: 'Listar Cotizaciones', desc: 'Ver y gestionar las cotizaciones existentes.', category: 'Cotizaciones' },
                            { id: 'crear_cotizacion', url: "{% url 'servicios:crear_cotizacion' %}", icon: '‚ûï', title: 'Crear Cotizaci√≥n', desc: 'Generar una nueva oferta de servicio.', category: 'Cotizaciones' },
                        ]
                    },
                ]
            },
            {
                id: 'trabajadores',
                icon: 'üë®‚Äçüíº',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Trabajadores',
                desc: 'Gestiona la informaci√≥n y roles de los empleados.',
                glow: '#6366f1',
                children: [
                    { id: 'trabajador_list', url: "{% url 'trabajadores:lista_trabajadores' %}", icon: 'üë®‚Äçüëß‚Äçüë¶', title: 'Listado de Trabajadores', desc: 'Ver todos los trabajadores.', category: 'Trabajadores' },
                    { id: 'trabajador_create', url: "{% url 'trabajadores:crear_trabajador' %}", icon: '‚ûï', title: 'Crear Trabajador', desc: 'Registrar un nuevo empleado.', category: 'Trabajadores' },
                ]
            },
            {
            id: 'proyectos',
            icon: 'üìÅ',
            category: 'Operaciones',
            title: 'M√≥dulo de Proyectos',
            desc: 'Controla el progreso y los detalles de los proyectos.',
            glow: '#a855f7',
            children: [
                {
                    id: 'gestion_proyectos',
                    icon: '‚úÖ',
                    title: 'Gesti√≥n de Proyectos',
                    desc: 'Administra los proyectos de la empresa.',
                    category: 'Proyectos',
                    children: [
                        { id: 'proyectos_list', url: "{% url 'proyectos:lista_proyectos_pendientes' %}", icon: 'üìã', title: 'Listar Proyectos', desc: 'Visualiza el estado de los proyectos.', category: 'Proyectos' },
                    ]
                },
                {
                    id: 'gestion_ordenes_ensayo',
                    icon: 'üìù',
                    title: 'Gesti√≥n de √ìrdenes de Ensayo',
                    desc: 'Gestiona las √≥rdenes de ensayo.',
                    category: '√ìrdenes de Ensayo',
                    children: [
                        { id: 'ordenes_ensayo_list', url: "", icon: 'üìã', title: 'Listar √ìrdenes', desc: 'Ver y gestionar las √≥rdenes de ensayo existentes.', category: '√ìrdenes de Ensayo' },
                        { id: 'ordenes_ensayo_nuevo', url: "", icon: '‚ûï', title: 'Nueva Orden', desc: 'Genera una nueva orden de ensayo.', category: '√ìrdenes de Ensayo' },
                    ]
                },
                {
                    id: 'gestion_muestras',
                    icon: 'üî¨',
                    title: 'Gesti√≥n de Muestras',
                    desc: 'Administra el registro de muestras.',
                    category: 'Muestras',
                    children: [
                        { id: 'muestras_list', url: "", icon: 'üìã', title: 'Listar Muestras', desc: 'Ver las muestras registradas.', category: 'Muestras' },
                        { id: 'muestras_nuevo', url: "", icon: '‚ûï', title: 'Nueva Muestra', desc: 'Registra una nueva muestra.', category: 'Muestras' },
                    ]
                },
                {
                    id: 'gestion_resultados',
                    icon: 'üìä',
                    title: 'Gesti√≥n de Resultados',
                    desc: 'Administra los resultados de los ensayos.',
                    category: 'Resultados',
                    children: [
                        { id: 'resultados_list', url: "", icon: 'üìã', title: 'Listar Resultados', desc: 'Ver los resultados de ensayo.', category: 'Resultados' },
                        { id: 'resultados_nuevo', url: "", icon: '‚ûï', title: 'Nuevo Resultado', desc: 'Registra un nuevo resultado.', category: 'Resultados' },
                    ]
                },
                {
                    id: 'gestion_documentos',
                    icon: 'üìÑ',
                    title: 'Gesti√≥n de Documentos',
                    desc: 'Administra los informes y documentos finales.',
                    category: 'Documentos',
                    children: [
                        { id: 'documentos_list', url: "", icon: 'üìã', title: 'Listar Documentos', desc: 'Ver los documentos finales generados.', category: 'Documentos' },
                        { id: 'documentos_nuevo', url: "", icon: '‚ûï', title: 'Nuevo Documento', desc: 'Sube un nuevo informe o documento final.', category: 'Documentos' },
                    ]
                },
            ]
        },
            {
                id: 'bolsa_trabajo',
                icon: 'üíº',
                category: 'RR.HH.',
                title: 'Bolsa de Trabajo',
                desc: 'Gestiona las candidaturas y ofertas de empleo.',
                glow: '#3b82f6',
                url: ""
            },
            {
                id: 'analisis',
                url: '#',
                icon: 'üìä',
                category: 'An√°lisis',
                title: 'Dashboard de An√°lisis',
                desc: 'M√©tricas y KPIs de tus proyectos.',
                glow: '#ef4444',
                action: 'show_analysis_view'
            },
        ];

        const cardContainer = document.getElementById('card-container');
        const inicioContent = document.getElementById('inicio-content');
        const analisisContent = document.getElementById('analisis-content');
        const cardOverlay = document.getElementById('card-overlay');
        const submenuModal = document.getElementById('submenu-modal');
        const submenuTitle = document.getElementById('submenu-title');
        const submenuList = document.getElementById('submenu-list');
        const closeSubmenuButton = document.getElementById('close-submenu');

        const setActiveView = (viewName) => {
            const isInicio = viewName === 'inicio';
            inicioContent.classList.toggle('hidden', !isInicio);
            analisisContent.classList.toggle('hidden', isInicio);
        };
        
        const closeSubmenu = () => {
            cardOverlay.classList.add('hidden', 'opacity-0');
            submenuModal.classList.remove('scale-100', 'opacity-100');
            submenuModal.classList.add('scale-95', 'opacity-0');
        };

        const renderCards = (items) => {
            cardContainer.innerHTML = '';
            items.forEach(card => {
                const cardElement = document.createElement('a');
                
                cardElement.className = 'dashboard-card glass-card rounded-2xl border border-white/10 p-6 flex flex-col justify-between h-52 group cursor-pointer block animate-fade-in-up transition-all duration-300 hover:shadow-[0_0_2rem_0.25rem] hover:scale-[1.01]';
                cardElement.style.boxShadow = `0 0 1rem 0.1rem ${card.glow}20`;
                cardElement.href = card.url || '#';
                
                cardElement.innerHTML = `
                    <div class="flex justify-between items-start transition-transform duration-300 group-hover:-translate-y-1">
                        <span class="text-5xl">${card.icon}</span>
                        ${card.category ? `<span class="text-xs font-bold uppercase" style="color:${card.glow};">${card.category}</span>` : ''}
                    </div>
                    <div class="transition-transform duration-300 group-hover:-translate-y-1">
                        <h4 class="text-xl font-bold text-white">${card.title}</h4>
                        <p class="text-sm text-slate-400">${card.desc}</p>
                    </div>
                `;

                cardElement.addEventListener('click', (e) => {
                    if (card.children && card.children.length > 0) {
                        e.preventDefault();
                        renderSubmenu(card);
                    } else if (card.action === 'show_analysis_view') {
                        e.preventDefault();
                        setActiveView('analisis');
                    }
                });
                cardContainer.appendChild(cardElement);
            });
        };

        const renderSubmenu = (parentCard) => {
            submenuTitle.textContent = parentCard.title;
            submenuList.innerHTML = '';
            
            parentCard.children.forEach(child => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = child.url || '#';
                link.className = 'flex items-center gap-4 p-3 rounded-lg hover:bg-white/5 transition-colors duration-200 group';
                link.innerHTML = `
                    <span class="text-2xl">${child.icon}</span>
                    <div class="flex-1">
                        <p class="text-white font-semibold">${child.title}</p>
                        <p class="text-xs text-slate-400">${child.desc}</p>
                    </div>
                `;
                
                link.addEventListener('click', (e) => {
                    if (child.children && child.children.length > 0) {
                        e.preventDefault();
                        renderSubmenu(child);
                    } else if (child.url) {
                        closeSubmenu();
                        window.location.href = child.url;
                    }
                });
                
                li.appendChild(link);
                submenuList.appendChild(li);
            });

            // Muestra el overlay y el modal con transici√≥n
            cardOverlay.classList.remove('hidden');
            setTimeout(() => {
                cardOverlay.classList.remove('opacity-0');
                submenuModal.classList.remove('scale-95', 'opacity-0');
                submenuModal.classList.add('scale-100', 'opacity-100');
            }, 10); // Un peque√±o retraso para la transici√≥n
        };

        const renderAnalysisDashboard = () => {
            analisisContent.innerHTML = `
            <header class="flex justify-between items-center mb-10 animate-fade-in-up">
                <div>
                    <h1 class="text-4xl font-extrabold text-white">Dashboard de An√°lisis</h1>
                    <p class="text-slate-400 mt-1">Avance y m√©tricas clave de tus proyectos.</p>
                </div>
                <button id="back-from-analysis" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-700/50 text-slate-300 font-semibold rounded-full hover:bg-slate-700 hover:text-white transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Volver al Panel
                </button>
            </header>
            <div class="glass-card p-6 rounded-2xl text-center"><p>Aqu√≠ ir√≠an tus gr√°ficos, KPIs y reportes de avance de proyectos.</p></div>`;
            document.getElementById('back-from-analysis').addEventListener('click', () => setActiveView('inicio'));
        };

        const commandItems = [];
        navigationData.forEach(item => {
            if (item.children && item.children.length > 0) { commandItems.push(...item.children); }
            else { commandItems.push(item); }
        });
        const commands = [
            ...commandItems.map(card => ({
                name: card.title, category: card.category || 'General',
                action: () => {
                    if (card.action === 'show_analysis_view') { setActiveView('analisis'); }
                    else { window.location.href = card.url; }
                }
            })),
            { name: 'Cerrar Sesi√≥n', category: 'Sistema', action: () => { window.location.href = "{% url 'logout' %}" } }
        ];

        const commandPalette = document.getElementById('command-palette');
        const commandInput = document.getElementById('command-input');
        const commandList = document.getElementById('command-list');
        const commandButtons = document.querySelectorAll('#command-palette-button-main');
        const openCommandPalette = () => { commandPalette.classList.remove('hidden'); commandInput.focus(); renderCommandList(commands); };
        const closeCommandPalette = () => { commandPalette.classList.add('hidden'); commandInput.value = ''; };
        const renderCommandList = (items) => {
            commandList.innerHTML = '';
            if (items.length === 0) { commandList.innerHTML = `<li class="p-3 text-slate-400">No se encontraron resultados.</li>`; return; }
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `p-3 text-slate-300 flex justify-between items-center rounded-lg cursor-pointer hover:bg-emerald-500/20 ${index === 0 ? 'bg-emerald-500/20' : ''}`;
                li.innerHTML = `<span>${item.name}</span> <span class="text-xs text-slate-500">${item.category}</span>`;
                li.addEventListener('click', () => { item.action(); closeCommandPalette(); });
                commandList.appendChild(li);
            });
        };

        renderCards(navigationData);
        renderAnalysisDashboard();
        setActiveView('inicio');

        commandButtons.forEach(btn => btn.addEventListener('click', openCommandPalette));
        commandInput.addEventListener('input', () => {
            const query = commandInput.value.toLowerCase();
            const filteredCommands = commands.filter(c => c.name.toLowerCase().includes(query));
            renderCommandList(filteredCommands);
        });
        
        // Listeners para el overlay y el submen√∫
        closeSubmenuButton.addEventListener('click', closeSubmenu);
        cardOverlay.addEventListener('click', (e) => {
            if (e.target === cardOverlay) {
                closeSubmenu();
            }
        });
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !cardOverlay.classList.contains('hidden')) {
                closeSubmenu();
            }
            if (e.key === 'Escape' && !commandPalette.classList.contains('hidden')) { 
                closeCommandPalette(); 
            }
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { 
                e.preventDefault(); 
                commandPalette.classList.contains('hidden') ? openCommandPalette() : closeCommandPalette(); 
            }
        });
    });
</script>
{% endblock %}