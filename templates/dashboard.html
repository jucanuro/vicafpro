{% extends 'base_vicafpro.html' %}
{% load static %}

{% block title %}VICAFPRO - Panel de Control{% endblock %}

{% block content %}

<div id="inicio-content">
    <header id="main-header" class="flex justify-between items-center mb-10 animate-fade-in-up">
        <div>
            <h1 class="text-4xl font-extrabold text-white">Panel de Control</h1>
            <p class="text-slate-400 mt-1">Hola, {{ user.get_full_name|default:user.username }}. Bienvenido al futuro de la gesti√≥n.</p>
        </div>
        <button id="command-palette-button-main"
            class="px-4 py-2 glass-card rounded-lg text-slate-300 hover:text-white hover:border-slate-400/50 transition-colors flex items-center gap-2">
            B√∫squeda r√°pida <span class="text-xs border border-slate-500 rounded px-1.5 py-0.5">Ctrl K</span>
        </button>
    </header>
    <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        </div>
</div>

<div id="analisis-content" class="hidden">
    </div>

{% endblock %}

{% block extra_content %}
<div id="command-palette"
    class="fixed inset-0 z-50 flex justify-center items-start pt-20 bg-black/50 backdrop-blur-sm hidden">
    <div class="glass-card w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden border-emerald-500/50">
        <input id="command-input" type="text" placeholder="Escribe un comando o busca una p√°gina..."
            class="w-full p-4 text-lg bg-transparent text-white focus:outline-none border-b border-slate-500/50">
        <ul id="command-list" class="p-2 max-h-96 overflow-y-auto"></ul>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DATOS DE NAVEGACI√ìN ---
       const navigationData = [
    // M√≥dulo de Clientes
            {
                id: 'clientes',
                icon: 'üë•',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Clientes',
                desc: 'Administra y revisa la base de datos de clientes.',
                glow: '#14b8a6', // Color verde azulado
                children: [
                    { id: 'lista_clientes', url: "{% url 'lista_clientes' %}", icon: 'üìã', title: 'Listado de Clientes', desc: 'Ver todos los clientes registrados.', category: 'Clientes' },
                    { id: 'crear_cliente', url: "{% url 'crear_cliente' %}", icon: '‚ûï', title: 'Crear Cliente', desc: 'Registrar un nuevo perfil de cliente.', category: 'Clientes' },
                ]
            },
            // M√≥dulo de Servicios
            {
                id: 'servicios',
                icon: 'üîß',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Servicios',
                desc: 'Administra los servicios y las cotizaciones de la empresa.',
                glow: '#f59e0b', // Color √°mbar
                children: [
                    { id: 'servicios', url: "{% url 'servicios:servicio_list' %}", icon: 'üìÉ', title: 'Listado de Servicios', desc: 'Ver el cat√°logo de servicios.', category: 'Servicios' },
                    { id: 'crear_servicio', url: "{% url 'servicios:servicio_create' %}", icon: '‚ûï', title: 'Crear Servicio', desc: 'Registrar un nuevo servicio.', category: 'Servicios' },
                    // Subm√≥dulo de Cotizaciones
                    { 
                        id: 'cotizaciones', 
                        icon: 'üí∏', 
                        title: 'Gesti√≥n de Cotizaciones', 
                        desc: 'Administra las cotizaciones de servicios.',
                        category: 'Cotizaciones',
                        children: [
                            { id: 'listar_cotizaciones', url: "{% url 'servicios:cotizacion_list' %}", icon: 'üìã', title: 'Listar Cotizaciones', desc: 'Ver y gestionar las cotizaciones existentes.', category: 'Cotizaciones' },
                            { id: 'crear_cotizacion', url: "{% url 'servicios:crear_cotizacion' %}", icon: 'üìù', title: 'Crear Cotizaci√≥n', desc: 'Generar una nueva oferta de servicio.', category: 'Cotizaciones' },
                        ]
                    },
                ]
            },
            // M√≥dulo de Trabajadores
            {
                id: 'trabajadores',
                icon: 'üë®‚Äçüíº',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Trabajadores',
                desc: 'Gestiona la informaci√≥n y roles de los empleados.',
                glow: '#6366f1', // Color √≠ndigo
                children: [
                    { id: 'trabajador_list', url: "{% url 'trabajador_list' %}", icon: 'üë®‚Äçüëß‚Äçüë¶', title: 'Listado de Trabajadores', desc: 'Ver todos los trabajadores.', category: 'Trabajadores' },
                    { id: 'trabajador_create', url: "{% url 'trabajador_create' %}", icon: '‚ûï', title: 'Crear Trabajador', desc: 'Registrar un nuevo empleado.', category: 'Trabajadores' },
                ]
            },
            // M√≥dulo de Proyectos
            {
                id: 'proyectos',
                icon: 'üìÇ',
                category: 'Operaciones',
                title: 'M√≥dulo de Proyectos',
                desc: 'Controla el progreso y los detalles de los proyectos.',
                glow: '#a855f7', // Color p√∫rpura
                children: [
                    { id: 'proyectos_list', url: "{% url 'proyectos:lista_proyectos' %}", icon: '‚úÖ', title: 'Ver Proyectos', desc: 'Visualiza el estado de los proyectos.', category: 'Proyectos' },
                    { id: 'proyectos_nuevo', url: "", icon: '‚ûï', title: 'Nuevo Proyecto', desc: 'Registra un nuevo proyecto.', category: 'Proyectos' },
                    { id: 'ordenes_ensayo', url: "{% url 'proyectos:orden_de_ensayo_list' %}", icon: 'üìù', title: '√ìrdenes de Ensayo', desc: 'Gestiona las √≥rdenes de ensayo.', category: 'Proyectos' },
                    { id: 'muestras', url: "{% url 'proyectos:muestra_list' %}", icon: 'üî¨', title: 'Muestras', desc: 'Ver y gestionar las muestras.', category: 'Proyectos' },
                    { id: 'resultados', url: "{% url 'proyectos:resultado_ensayo_list' %}", icon: 'üìä', title: 'Resultados de Ensayo', desc: 'Registra los resultados de laboratorio.', category: 'Proyectos' },
                    { id: 'documentos', url: "{% url 'proyectos:documento_final_list' %}", icon: 'üìÑ', title: 'Documentos Finales', desc: 'Administra los informes finales.', category: 'Proyectos' },
                ]
            },
            // M√≥dulo de Bolsa de Trabajo
            {
                id: 'bolsa_trabajo',
                icon: 'üíº',
                category: 'RR.HH.',
                title: 'Bolsa de Trabajo',
                desc: 'Gestiona las candidaturas y ofertas de empleo.',
                glow: '#3b82f6', // Color azul
                url: ""
            },
            // M√≥dulo de An√°lisis
            {
                id: 'analisis',
                url: '#',
                icon: 'üìä',
                category: 'An√°lisis',
                title: 'Dashboard de An√°lisis',
                desc: 'M√©tricas y KPIs de tus proyectos.',
                glow: '#ef4444', // Color rojo
                action: 'show_analysis_view'
            },
        ];

        // --- 2. ELEMENTOS DEL DOM Y L√ìGICA DE VISTAS (sin cambios) ---
        const inicioContent = document.getElementById('inicio-content');
        const analisisContent = document.getElementById('analisis-content');
        const cardContainer = document.getElementById('card-container');
        const mainHeader = document.getElementById('main-header');

        const setActiveView = (viewName) => {
            const isInicio = viewName === 'inicio';
            inicioContent.classList.toggle('hidden', !isInicio);
            analisisContent.classList.toggle('hidden', isInicio);
        };

        const renderCards = (items, parentItem = null) => {
            cardContainer.innerHTML = '';
            if (parentItem) {
                const backButton = document.createElement('div');
                backButton.className = 'col-span-full mb-4 animate-fade-in';
                backButton.innerHTML = `<button id="back-to-main" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-700/50 text-slate-300 font-semibold rounded-full hover:bg-slate-700 hover:text-white transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Volver al Panel Principal</button>`;
                cardContainer.appendChild(backButton);
                document.getElementById('back-to-main').addEventListener('click', () => {
                    mainHeader.style.display = 'flex';
                    renderCards(navigationData);
                });
            }
            items.forEach(card => {
                const cardElement = document.createElement('a');
                cardElement.className = 'dashboard-card card-3d glass-card rounded-2xl p-6 flex flex-col justify-between h-52 group cursor-pointer block animate-fade-in-up';
                cardElement.href = card.url || '#';
                cardElement.innerHTML = `<div class="flex justify-between items-start"><span class="text-5xl">${card.icon}</span> ${card.category ? `<span class="text-xs font-bold uppercase" style="color:${card.glow};">${card.category}</span>` : ''}</div><div><h4 class="text-xl font-bold text-white">${card.title}</h4><p class="text-sm text-slate-400">${card.desc}</p></div>`;
                cardElement.addEventListener('click', (e) => {
                    if (card.children && card.children.length > 0) {
                        e.preventDefault();
                        mainHeader.style.display = 'none';
                        renderCards(card.children, { title: 'Panel Principal' });
                    } else if (card.action === 'show_analysis_view') {
                        e.preventDefault();
                        setActiveView('analisis');
                    }
                });
                cardContainer.appendChild(cardElement);
            });
        };

        const renderAnalysisDashboard = () => {
            analisisContent.innerHTML = `
            <header class="flex justify-between items-center mb-10 animate-fade-in-up">
                <div>
                    <h1 class="text-4xl font-extrabold text-white">Dashboard de An√°lisis</h1>
                    <p class="text-slate-400 mt-1">Avance y m√©tricas clave de tus proyectos.</p>
                </div>
                <button id="back-from-analysis" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-700/50 text-slate-300 font-semibold rounded-full hover:bg-slate-700 hover:text-white transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Volver al Panel
                </button>
            </header>
            <div class="glass-card p-6 rounded-2xl text-center"><p>Aqu√≠ ir√≠an tus gr√°ficos, KPIs y reportes de avance de proyectos.</p></div>`;
            document.getElementById('back-from-analysis').addEventListener('click', () => setActiveView('inicio'));
        };

        const commandItems = [];
        navigationData.forEach(item => {
            if (item.children && item.children.length > 0) { commandItems.push(...item.children); }
            else { commandItems.push(item); }
        });
        const commands = [
            ...commandItems.map(card => ({
                name: card.title, category: card.category || 'General',
                action: () => {
                    if (card.action === 'show_analysis_view') { setActiveView('analisis'); }
                    else { window.location.href = card.url; }
                }
            })),
            { name: 'Cerrar Sesi√≥n', category: 'Sistema', action: () => { window.location.href = "{% url 'logout' %}" } }
        ];

        const commandPalette = document.getElementById('command-palette');
        const commandInput = document.getElementById('command-input');
        const commandList = document.getElementById('command-list');
        const commandButtons = document.querySelectorAll('#command-palette-button-main');
        const openCommandPalette = () => { commandPalette.classList.remove('hidden'); commandInput.focus(); renderCommandList(commands); };
        const closeCommandPalette = () => { commandPalette.classList.add('hidden'); commandInput.value = ''; };
        const renderCommandList = (items) => {
            commandList.innerHTML = '';
            if (items.length === 0) { commandList.innerHTML = `<li class="p-3 text-slate-400">No se encontraron resultados.</li>`; return; }
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `p-3 text-slate-300 flex justify-between items-center rounded-lg cursor-pointer hover:bg-emerald-500/20 ${index === 0 ? 'bg-emerald-500/20' : ''}`;
                li.innerHTML = `<span>${item.name}</span> <span class="text-xs text-slate-500">${item.category}</span>`;
                li.addEventListener('click', () => { item.action(); closeCommandPalette(); });
                commandList.appendChild(li);
            });
        };

        // --- 3. INICIALIZACI√ìN ---
        renderCards(navigationData);
        renderAnalysisDashboard();
        setActiveView('inicio');

        commandButtons.forEach(btn => btn.addEventListener('click', openCommandPalette));
        commandInput.addEventListener('input', () => {
            const query = commandInput.value.toLowerCase();
            const filteredCommands = commands.filter(c => c.name.toLowerCase().includes(query));
            renderCommandList(filteredCommands);
        });
        commandPalette.addEventListener('click', (e) => { if (e.target === commandPalette) { closeCommandPalette(); } });
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !commandPalette.classList.contains('hidden')) { closeCommandPalette(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); commandPalette.classList.contains('hidden') ? openCommandPalette() : closeCommandPalette(); }
        });
    });
</script>
{% endblock %}